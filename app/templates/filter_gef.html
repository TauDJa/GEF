{% extends "layout.html" %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--multiple {
        border: 1px solid #ced4da;
    }
    .select2-container {
        width: 100% !important;
    }
</style>
{% endblock %}


{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-filter"></i> Filtrer les Géomètres-Experts Foncier</h2>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Retour au Dashboard</a>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white">
            Critères de recherche
        </div>
        <div class="card-body">
            <form action="{{ url_for('main.filter_gefs') }}" method="GET">
                
                <h5 class="mb-3">Filtres GEF</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="wilayaSelect" class="form-label">Wilaya</label>
                        <select class="form-select" id="wilayaSelect" name="wilaya">
                            <option value="">-- Toutes les wilayas --</option>
                            {% for wilaya in wilayas %}
                                <option value="{{ wilaya.code }}" {% if selected_wilaya == wilaya.code %}selected{% endif %}>{{ wilaya.nom_wilaya }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="communeSelect" class="form-label">Commune</label>
                        <select class="form-select" id="communeSelect" name="commune" {% if not selected_wilaya %}disabled{% endif %}>
                            <option value="">-- Toutes les communes --</option>
                             {% for commune in communes %}
                                <option value="{{ commune.code_commu }}" {% if selected_commune == commune.code_commu %}selected{% endif %}>{{ commune.nom_commun }}</option>
                            {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-4 mb-3">
                        <label for="statut_bureau" class="form-label">Statut du bureau</label>
                        <select class="form-select" id="statut_bureau" name="statut_bureau">
                            <option value="">-- Tous --</option>
                            <option value="Prop" {% if statut_bureau == 'Prop' %}selected{% endif %}>Propriétaire</option>
                            <option value="Loc" {% if statut_bureau == 'Loc' %}selected{% endif %}>Locataire</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                   <div class="col-md-4 mb-3">
                        <label for="situation" class="form-label">Situation</label>
                        <select class="form-select" id="situation" name="situation">
                            <option value="">-- Toutes --</option>
                            <option value="actif" {% if situation == 'actif' %}selected{% endif %}>Actif</option>
                            <option value="mise en dispo" {% if situation == 'mise en dispo' %}selected{% endif %}>Mise en dispo</option>
                            <option value="suspendu" {% if situation == 'suspendu' %}selected{% endif %}>Suspendu</option>
                        </select>
                    </div>
                     <div class="col-md-8 mb-3">
                        <label for="agrementsSelect" class="form-label">Agréments (doit posséder tous les agréments sélectionnés)</label>
                        <select class="form-select" id="agrementsSelect" name="agrements" multiple>
                            {% for agrement in agrements %}
                                <option value="{{ agrement.id }}" {% if agrement.id in selected_agrements %}selected{% endif %}>{{ agrement.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="equipementsSelect" class="form-label">Équipements (doit posséder tous les équipements sélectionnés)</label>
                        <select class="form-select" id="equipementsSelect" name="equipements" multiple>
                           {% for equipement in type_equipements %}
                                <option value="{{ equipement.id_type }}" {% if equipement.id_type in selected_equipements %}selected{% endif %}>{{ equipement.nom_type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <hr>

                <h5 class="mb-3">Filtres Personnel</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="personnel_nom" class="form-label">Nom du personnel</label>
                        <input type="text" class="form-control" id="personnel_nom" name="personnel_nom" value="{{ personnel_nom or '' }}" placeholder="Rechercher par nom...">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="personnel_prenom" class="form-label">Prénom du personnel</label>
                        <input type="text" class="form-control" id="personnel_prenom" name="personnel_prenom" value="{{ personnel_prenom or '' }}" placeholder="Rechercher par prénom...">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="personnel_profile" class="form-label">Profil du personnel</label>
                        <select class="form-select" id="personnel_profile" name="personnel_profile">
                            <option value="">-- Tous les profils --</option>
                            {% set profiles = ["Stagiaire", "Ingénieur", "Technicien Supérieur", "Topographe", "Secrétaire", "Autre"] %}
                            {% for profile in profiles %}
                                <option value="{{ profile }}" {% if personnel_profile == profile %}selected{% endif %}>{{ profile }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>


                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('main.filter_gefs') }}" class="btn btn-secondary">Réinitialiser</a>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Rechercher</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
           <span>Résultats de la recherche</span>
           <span class="badge bg-light text-dark">{{ gefs_results|length }} GEF(s) trouvé(s)</span>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Numéro</th>
                        <th>Nom & Prénom</th>
                        <th>Wilaya</th>
                        <th>Commune</th>
                        <th>Situation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gef in gefs_results %}
                    <tr>
                        <td>{{ gef.numero }}</td>
                        <td>{{ gef.n_p }}</td>
                        <td>{{ gef.commune.wilaya.nom_wilaya if gef.commune and gef.commune.wilaya else 'N/A' }}</td>
                        <td>{{ gef.commune.nom_commun if gef.commune else 'N/A' }}</td>
                        <td><span class="badge {% if gef.situation == 'actif' %}bg-success{% else %}bg-warning{% endif %}">{{ gef.situation }}</span></td>
                        <td>
                            <a href="{{ url_for('main.edit_gef', gef_numero=gef.numero) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i>Détails / Modifier</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">Aucun GEF ne correspond à vos critères de recherche.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialiser Select2
    $('#wilayaSelect').select2({ placeholder: "-- Toutes les wilayas --", allowClear: true });
    $('#communeSelect').select2({ placeholder: "-- Toutes les communes --", allowClear: true });
    $('#agrementsSelect').select2({ placeholder: "Sélectionnez un ou plusieurs agréments", allowClear: true });
    $('#equipementsSelect').select2({ placeholder: "Sélectionnez un ou plusieurs équipements", allowClear: true });
    // ✅ PAS BESOIN DE SELECT2 POUR LES NOUVEAUX CHAMPS (sauf si vous le souhaitez)

    // Logique de chargement dynamique des communes (inchangée)
    $('#wilayaSelect').on('change', function() {
        const wilayaCode = $(this).val();
        const communeSelect = $('#communeSelect');

        communeSelect.empty().append('<option value="">Chargement...</option>').prop('disabled', true);

        if (wilayaCode) {
            fetch(`/api/communes/${wilayaCode}`)
                .then(response => response.json())
                .then(data => {
                    communeSelect.empty().append('<option value="">-- Toutes les communes --</option>');
                    data.forEach(commune => {
                        communeSelect.append(new Option(commune.nom, commune.code, false, false));
                    });
                    communeSelect.prop('disabled', false);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    communeSelect.empty().append('<option value="">Erreur de chargement</option>');
                });
        } else {
            communeSelect.empty().append('<option value="">-- D\'abord, sélectionnez une wilaya --</option>').prop('disabled', true);
        }
    });
});
</script>
{% endblock %}