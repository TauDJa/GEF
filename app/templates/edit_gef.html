{% extends "layout.html" %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2><i class="fas fa-edit"></i> Modifier le GEF N° {{ gef.numero }}</h2>
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Retour au Dashboard</a>
    </div>
    <hr>

    <form action="{{ url_for('main.update_gef', gef_numero=gef.numero) }}" method="POST" enctype="multipart/form-data">
        
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">Informations Principales</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Numéro d'agrément</label>
                        <input type="number" class="form-control" value="{{ gef.numero }}" disabled>
                        <input type="hidden" name="numero" value="{{ gef.numero }}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="date_obt" class="form-label">Date d'obtention</label>
                        <input type="date" class="form-control" id="date_obt" name="date_obt" 
                               value="{{ gef.date_obt.strftime('%Y-%m-%d') if gef.date_obt else '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="n_p" class="form-label">Nom & Prénom *</label>
                        <input type="text" class="form-control" id="n_p" name="n_p" value="{{ gef.n_p }}" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="date_naissance" class="form-label">Né(e) le</label>
                        <input type="date" class="form-control" id="date_naissance" name="date_naiss"
                               value="{{ gef.date_naiss.strftime('%Y-%m-%d') if gef.date_naiss else '' }}">
                    </div>
                </div>
                <div class="row align-items-center mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Photo Actuelle</label>
                        {% if gef.photo_filename %}
                            <img src="{{ url_for('main.get_uploaded_file', filename=gef.photo_filename) }}" 
                                 alt="Photo de {{ gef.n_p }}" class="img-thumbnail" style="max-height: 150px;">
                        {% else %}
                            <div class="text-muted border p-3 text-center rounded">
                                <i class="fas fa-user fa-3x"></i><br>
                                <small>Aucune photo</small>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-9">
                        <label for="photo" class="form-label">Changer la photo (Optionnel)</label>
                        <input class="form-control" type="file" id="photo" name="photo" accept="image/png, image/jpeg, image/jpg">
                        <small class="form-text text-muted">Laisser vide pour conserver la photo actuelle. Formats : .png, .jpg, .jpeg</small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="lieu_naiss_wc" class="form-label">Lieu de naissance</label>
                        <input type="text" class="form-control" id="lieu_naiss_wc" name="lieu_naiss_wc" value="{{ gef.lieu_naiss_wc or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lieu_naiss_cc" class="form-label">Commune de naissance</label>
                        <input type="text" class="form-control" id="lieu_naiss_cc" name="lieu_naiss_cc" value="{{ gef.lieu_naiss_cc or '' }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nim" class="form-label">NIM</label>
                        <input type="number" class="form-control" id="nim" name="nim" value="{{ gef.nim or '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nif" class="form-label">NIF</label>
                        <input type="number" class="form-control" id="nif" name="nif" value="{{ gef.nif or '' }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ gef.email or '' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="wilayaSelect" class="form-label">Wilaya *</label>
                        <select class="form-select" id="wilayaSelect" required>
                            {% for wilaya in wilayas %}
                                <option value="{{ wilaya.code }}" {% if gef.commune and wilaya.code == gef.commune.code_wilaya %}selected{% endif %}>
                                    {{ wilaya.nom_wilaya }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="commune_c" class="form-label">Commune *</label>
                        <select class="form-select" id="commune_c" name="commune_c" required>
                            {% for commune in communes %}
                                <option value="{{ commune.code_commu }}" {% if commune.code_commu == gef.commune_c %}selected{% endif %}>
                                    {{ commune.nom_commun }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="adresse" class="form-label">Adresse</label>
                    <textarea class="form-control" id="adresse" name="adresse" rows="2">{{ gef.adresse or '' }}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="statut_bureau" class="form-label">Statut du bureau</label>
                        <select class="form-select" id="statut_bureau" name="statut_bureau">
                            <option value="Prop" {% if gef.statut_bureau == 'Prop' %}selected{% endif %}>Propriétaire</option>
                            <option value="Loc" {% if gef.statut_bureau == 'Loc' %}selected{% endif %}>Locataire</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="situation" class="form-label">Situation</label>
                        <select class="form-select" id="situation" name="situation">
                            <option value="actif" {% if gef.situation == 'actif' %}selected{% endif %}>Actif</option>
                            <option value="mise en dispo" {% if gef.situation == 'mise en dispo' %}selected{% endif %}>Mise en dispo</option>
                            <option value="suspendu" {% if gef.situation == 'Suspendu' %}selected{% endif %}>Suspendu</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="observations" class="form-label">Observations / Notes</label>
                        <textarea class="form-control" id="observations" name="observations" rows="3">{{ gef.observations or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>Personnel</span>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="addPersonnel()"><i class="fas fa-plus"></i> Ajouter</button>
            </div>
            <div class="card-body" id="personnel-container">
                {% for p in personnels %}
                <div class="row align-items-center mb-2 personnel-row">
                    <div class="col-md-4"><input type="text" name="personnel_nom" class="form-control" placeholder="Nom" value="{{ p.nom }}" required></div>
                    <div class="col-md-3"><input type="text" name="personnel_prenom" class="form-control" placeholder="Prénom" value="{{ p.prenom }}" required></div>
                    
                    <div class="col-md-4">
                        {% set profiles = ["Stagiaire", "Ingénieur", "Technicien Supérieur", "Topographe", "Secrétaire", "Autre"] %}
                        <select name="personnel_profile" class="form-select" required>
                            <option value="">-- Sélectionnez un profil --</option>
                            {% for profile in profiles %}
                                <option value="{{ profile }}" {% if p.profile == profile %}selected{% endif %}>{{ profile }}</option>
                            {% endfor %}
                            {% if p.profile and p.profile not in profiles %}
                                 <option value="{{ p.profile }}" selected>{{ p.profile }} (actuel)</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.personnel-row').remove()"><i class="fas fa-trash"></i></button></div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>Téléphones</span>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="addTelephone()"><i class="fas fa-plus"></i> Ajouter</button>
            </div>
            <div class="card-body" id="telephones-container">
                {% for tel in telephones %}
                <div class="row align-items-center mb-2 telephone-row">
                    <div class="col-md-5">
                        <select name="telephone_type" class="form-select">
                            <option value="Mobile" {% if tel.type_tel == 'Mobile' %}selected{% endif %}>Mobile</option>
                            <option value="Fixe" {% if tel.type_tel == 'Fixe' %}selected{% endif %}>Fixe</option>
                            <option value="Fax" {% if tel.type_tel == 'Fax' %}selected{% endif %}>Fax</option>
                        </select>
                    </div>
                    <div class="col-md-6"><input type="text" name="telephone_numero" class="form-control" placeholder="Numéro" value="{{ tel.num }}" required></div>
                    <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.telephone-row').remove()"><i class="fas fa-trash"></i></button></div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>Équipements</span>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="addEquipement()"><i class="fas fa-plus"></i> Ajouter</button>
            </div>
            <div class="card-body" id="equipements-container">
                {% for eq_id, eq_quantite in ids_equipements_actuels.items() %}
                <div class="row align-items-center mb-2 equipement-row">
                    <div class="col-md-8">
                        <select name="equipement_id" class="form-select">
                            {% for equipement in type_equipements %}
                                <option value="{{ equipement.id_type }}" {% if equipement.id_type == eq_id %}selected{% endif %}>
                                    {{ equipement.nom_type }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3"><input type="number" name="equipement_quantite" class="form-control" value="{{ eq_quantite }}" min="1" required></div>
                    <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.equipement-row').remove()"><i class="fas fa-trash"></i></button></div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">Agréments</div>
            <div class="card-body">
                <div class="row">
                {% for agrement in agrements %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="agrement_ids" value="{{ agrement.id }}" id="agrement-{{ agrement.id }}" {% if agrement.id in ids_agrements_actuels %}checked{% endif %}>
                            <label class="form-check-label" for="agrement-{{ agrement.id }}">{{ agrement.nom }}</label>
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save"></i> Mettre à jour le GEF</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Script de chargement dynamique Wilaya/Commune (inchangé)
    $(document).ready(function() {
        $('#wilayaSelect').select2({ placeholder: "-- Recherchez une wilaya --" });
        $('#commune_c').select2({ placeholder: "-- Recherchez une commune --" });
        $('#wilayaSelect').on('change', function() {
            const wilayaCode = $(this).val();
            const communeSelect = $('#commune_c');
            communeSelect.empty().append('<option value="">Chargement...</option>').prop('disabled', true).trigger('change');
            if (wilayaCode) {
                fetch(`/api/communes/${wilayaCode}`)
                    .then(response => response.json())
                    .then(data => {
                        communeSelect.empty().append('<option value="">-- Sélectionnez une commune --</option>');
                        data.forEach(commune => {
                            const option = new Option(commune.nom, commune.code, false, false);
                            communeSelect.append(option);
                        });
                        communeSelect.prop('disabled', false);
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des communes:', error);
                        communeSelect.empty().append('<option value="">Erreur de chargement</option>');
                    });
            } else {
                communeSelect.empty().append('<option value="">-- D\'abord, sélectionnez une wilaya --</option>').prop('disabled', true);
            }
        });
    });

    // --- Fonctions JavaScript pour ajouter dynamiquement des champs ---

    function addPersonnel() {
        const container = document.getElementById('personnel-container');
        const newPersonnel = document.createElement('div');
        newPersonnel.className = 'row align-items-center mb-2 personnel-row';
        
        // ✅ MODIFIÉ : Remplacé l'input "profil" par un <select>
        newPersonnel.innerHTML = `
            <div class="col-md-4"><input type="text" name="personnel_nom" class="form-control" placeholder="Nom" required></div>
            <div class="col-md-3"><input type="text" name="personnel_prenom" class="form-control" placeholder="Prénom" required></div>
            <div class="col-md-4">
                <select name="personnel_profile" class="form-select" required>
                    <option value="">-- Sélectionnez un profil --</option>
                    <option value="Stagiaire">Stagiaire</option>
                    <option value="Ingénieur">Ingénieur</option>
                    <option value="Technicien Supérieur">Technicien Supérieur</option>
                    <option value="Topographe">Topographe</option>
                    <option value="Secrétaire">Secrétaire</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.personnel-row').remove()"><i class="fas fa-trash"></i></button></div>
        `;
        container.appendChild(newPersonnel);
    }

    function addTelephone() {
        const container = document.getElementById('telephones-container');
        const newTelephone = document.createElement('div');
        newTelephone.className = 'row align-items-center mb-2 telephone-row';
        newTelephone.innerHTML = `
            <div class="col-md-5">
                <select name="telephone_type" class="form-select">
                    <option value="Mobile">Mobile</option>
                    <option value="Fixe">Fixe</option>
                    <option value="Fax">Fax</option>
                </select>
            </div>
            <div class="col-md-6"><input type="text" name="telephone_numero" class="form-control" placeholder="Numéro" required></div>
            <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.telephone-row').remove()"><i class="fas fa-trash"></i></button></div>
        `;
        container.appendChild(newTelephone);
    }
    
    function addEquipement() {
        const container = document.getElementById('equipements-container');
        const newEquipement = document.createElement('div');
        newEquipement.className = 'row align-items-center mb-2 equipement-row';
        newEquipement.innerHTML = `
            <div class="col-md-8">
                <select name="equipement_id" class="form-select">
                    {% for equipement in type_equipements %}
                        <option value="{{ equipement.id_type }}">{{ equipement.nom_type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3"><input type="number" name="equipement_quantite" class="form-control" value="1" min="1" required></div>
            <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.equipement-row').remove()"><i class="fas fa-trash"></i></button></div>
        `;
        container.appendChild(newEquipement);
    }
</script>
{% endblock %}